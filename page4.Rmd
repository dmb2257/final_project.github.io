---
title: "Page 4"
output: 
  html_document:
    toc: true
    toc_float: true
---

Olivia's Workspace

# Header
text here 

## Subsection 1
text/code here

## Subsection 2
text/code here
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo    = TRUE,
  message = FALSE,
  warning = FALSE
)

library(haven)
library(dplyr)
library(tidyr)
library(ggplot2)
library(janitor)
library(knitr)
library(forcats)
library(lubridate)

# Read in the full transplant dataset from SAS file
tx_li <- read_sas(file.choose())

# Create donor-focused dataset
donor_tx <- tx_li %>%
  select(
    DONOR_ID,
    REC_TX_DT,
    REC_AGE_AT_TX,
    DON_CAD_DON_COD,
    DON_DEATH_MECH,
    DON_DEATH_CIRCUM,
    DON_AGE,
    DON_AGE_IN_MONTHS,
    DON_HIST_CANCER,
    DON_HIST_DIAB,
    DON_HIST_HYPERTEN,
    DON_HIST_COCAINE,
    DON_HIST_IV_DRUG,
    DON_HIST_OTHER_DRUG,
    DON_CONT_CIGARETTE,
    DON_CONT_COCAINE,
    DON_CONT_IV_DRUG,
    DON_CONT_OTHER_DRUG,
    DON_MEET_CDC_HIGH_RISK
  )

glimpse(donor_tx)
```

```{r}
# Restrict to donors with observed donor age and cause of death, keeping only adult donors aged 18 years or older and limiting to transplant years 2020 and later.
donor_tx_clean <- donor_tx %>%
  filter(
    !is.na(DON_CAD_DON_COD),
    !is.na(DON_AGE),
    DON_AGE >= 18,
    lubridate::year(tx_date) >= 2020
  )

# Create categorical age groups for adult donors.
donor_tx_clean <- donor_tx_clean %>%
  mutate(
    age_group = cut(
      DON_AGE,
      breaks = c(18, 34, 49, 64, Inf),
      labels = c("18–34", "35–49", "50–64", "65+"),
      right  = TRUE
    )
  )

# Calculate the total number of eligible adult donors in the dataset.
n_total <- nrow(donor_tx_clean)

# Generate summary statistics for cause of death including counts, percentages, and age distribution metrics.
death_lifespan_table <- donor_tx_clean %>%
  group_by(DON_CAD_DON_COD) %>%
  summarise(
    n_donors      = n(),
    pct_of_donors = round(100 * n_donors / n_total, 1),
    median_age    = round(median(DON_AGE, na.rm = TRUE), 1),
    iqr_age       = round(IQR(DON_AGE, na.rm = TRUE), 1),
    mean_age      = round(mean(DON_AGE, na.rm = TRUE), 1),
    sd_age        = round(sd(DON_AGE, na.rm = TRUE), 1),
    .groups       = "drop"
  ) %>%
  arrange(desc(n_donors)) %>%
  rename(cause_of_death_code = DON_CAD_DON_COD)

# Display the summary statistics table in the console.
print(death_lifespan_table)

# Produce a formatted table summarizing adult donor cause of death and lifespan metrics.
kable(
  death_lifespan_table,
  caption = "Table. Distribution of Donor Cause of Death and Lifespan (Adults ≥18, TX ≥2020)."
)

# Create a cross-tabulation of cause of death by adult age group to examine proportional patterns.
death_by_agegroup <- donor_tx_clean %>%
  count(DON_CAD_DON_COD, age_group) %>%
  group_by(age_group) %>%
  mutate(
    pct_within_age = round(100 * n / sum(n), 1)
  ) %>%
  ungroup() %>%
  rename(cause_of_death_code = DON_CAD_DON_COD)

# Display the cross-tabulated dataset in the console.
print(death_by_agegroup)

# Produce a formatted table summarizing cause of death frequencies within each age group.
kable(
  death_by_agegroup,
  caption = "Table. Donor Cause of Death by Age Group (Adults ≥18, TX ≥2020).",
  align = "c"
)

# Create a bar plot comparing median donor age across cause-of-death categories.
p_median_age_cod <- death_lifespan_table %>%
  ggplot(aes(
    x = fct_reorder(as.factor(cause_of_death_code), median_age),
    y = median_age
  )) +
  geom_col(alpha = 0.85) +
  coord_flip() +
  labs(
    title = "Median Donor Age by Cause-of-Death Code (Adults ≥18, TX ≥2020).",
    x     = "Cause of Death Code",
    y     = "Median Age (years)"
  ) +
  theme_minimal(base_size = 13)

# Print the median age plot.
print(p_median_age_cod)

# Identify the six most common causes of death among adult donors.
top_causes <- death_lifespan_table %>%
  slice_max(n_donors, n = 6) %>%
  pull(cause_of_death_code)

# Create a boxplot visualizing age distributions for the most common causes of donor death.
p_age_by_cod <- donor_tx_clean %>%
  filter(DON_CAD_DON_COD %in% top_causes) %>%
  mutate(cause_of_death_code = as.factor(DON_CAD_DON_COD)) %>%
  ggplot(aes(
    x = fct_reorder(cause_of_death_code, DON_AGE, .fun = median),
    y = DON_AGE
  )) +
  geom_boxplot(alpha = 0.8) +
  coord_flip() +
  labs(
    title = "Donor Age Distribution Across Common Causes of Death (Adults ≥18, TX ≥2020).",
    x     = "Cause of Death Code",
    y     = "Donor Age (years)"
  ) +
  theme_minimal(base_size = 13)

# Print the donor age distribution plot.
print(p_age_by_cod)

# Create a stacked bar chart showing the age group composition within each top cause of death.
p_agegroup_by_cod <- donor_tx_clean %>%
  filter(DON_CAD_DON_COD %in% top_causes) %>%
  mutate(cause_of_death_code = as.factor(DON_CAD_DON_COD)) %>%
  count(cause_of_death_code, age_group) %>%
  group_by(cause_of_death_code) %>%
  mutate(pct_within_cause = n / sum(n)) %>%
  ungroup() %>%
  ggplot(aes(
    x   = fct_reorder(cause_of_death_code, -pct_within_cause),
    y   = pct_within_cause,
    fill = age_group
  )) +
  geom_col() +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    title = "Age Group Distribution Within Common Causes of Death (Adults ≥18, TX ≥2020).",
    x     = "Cause of Death Code",
    y     = "Percent of Donors",
    fill  = "Age Group"
  ) +
  theme_minimal(base_size = 13)

# Print the stacked age-group composition plot.
print(p_agegroup_by_cod)
```

```{r}
# Restrict to donors with non-missing cause of death and age, keep only adult donors (18 years and older), and limit to transplants from 2020 onward.
donor_tx_clean <- donor_tx %>%
  filter(
    !is.na(DON_CAD_DON_COD),
    !is.na(DON_AGE),
    DON_AGE >= 18,
    tx_year >= 2020
  )

# Create categorical age groups for adult donors.
donor_tx_clean <- donor_tx_clean %>%
  mutate(
    age_group = cut(
      DON_AGE,
      breaks = c(18, 34, 49, 64, Inf),
      labels = c("18–34", "35–49", "50–64", "65+"),
      right  = TRUE
    )
  )

# Calculate the total number of eligible adult donors in the dataset.
n_total <- nrow(donor_tx_clean)

# Summarize donors by cause of death to obtain counts, percentages, and lifespan metrics.
death_lifespan_table <- donor_tx_clean %>%
  group_by(DON_CAD_DON_COD) %>%
  summarise(
    n_donors      = n(),
    pct_of_donors = round(100 * n_donors / n_total, 1),
    median_age    = round(median(DON_AGE, na.rm = TRUE), 1),
    iqr_age       = round(IQR(DON_AGE, na.rm = TRUE), 1),
    mean_age      = round(mean(DON_AGE, na.rm = TRUE), 1),
    sd_age        = round(sd(DON_AGE, na.rm = TRUE), 1),
    .groups       = "drop"
  ) %>%
  arrange(desc(n_donors)) %>%
  rename(cause_of_death_code = DON_CAD_DON_COD)

# Print the donor cause-of-death summary table to the console.
print(death_lifespan_table)

# Produce a formatted table summarizing donor cause of death and lifespan metrics for adult donors.
kable(
  death_lifespan_table,
  caption = "Table. Distribution of Donor Cause of Death and Lifespan (Adults ≥18, TX ≥2020)."
)

# Create a cross-tabulation of cause of death by adult age group to examine proportional patterns.
death_by_agegroup <- donor_tx_clean %>%
  count(DON_CAD_DON_COD, age_group) %>%
  group_by(age_group) %>%
  mutate(
    pct_within_age = round(100 * n / sum(n), 1)
  ) %>%
  ungroup() %>%
  rename(cause_of_death_code = DON_CAD_DON_COD)

# Print the cross-tabulation of cause of death by age group to the console.
print(death_by_agegroup)

# Produce a formatted table summarizing donor cause of death by age group for adult donors.
kable(
  death_by_agegroup,
  caption = "Table. Donor Cause of Death by Age Group (Adults ≥18, TX ≥2020).",
  align = "c"
)

# Create a bar plot of median donor age for each cause-of-death code among adult donors.
p_median_age_cod <- death_lifespan_table %>%
  ggplot(aes(
    x = fct_reorder(as.factor(cause_of_death_code), median_age),
    y = median_age
  )) +
  geom_col(alpha = 0.85) +
  coord_flip() +
  labs(
    title = "Median Donor Age by Cause-of-Death Code (Adults ≥18, TX ≥2020).",
    x     = "Cause of Death Code",
    y     = "Median Age (years)"
  ) +
  theme_minimal(base_size = 13)

# Print the median donor age plot.
print(p_median_age_cod)

# Identify the most common causes of death among adult donors to focus age comparisons.
top_causes <- death_lifespan_table %>%
  slice_max(n_donors, n = 6) %>%
  pull(cause_of_death_code)

# Create a boxplot showing donor age distributions for the most common causes of death among adult donors.
p_age_by_cod <- donor_tx_clean %>%
  filter(DON_CAD_DON_COD %in% top_causes) %>%
  mutate(cause_of_death_code = as.factor(DON_CAD_DON_COD)) %>%
  ggplot(aes(
    x = fct_reorder(cause_of_death_code, DON_AGE, .fun = median),
    y = DON_AGE
  )) +
  geom_boxplot(alpha = 0.8) +
  coord_flip() +
  labs(
    title = "Donor Age Distribution by Leading Causes of Death (Adults ≥18, TX ≥2020).",
    x     = "Cause of Death Code",
    y     = "Donor Age (years)"
  ) +
  theme_minimal(base_size = 13)

# Print the donor age distribution plot.
print(p_age_by_cod)

# Create a stacked bar chart showing age group composition within the most common causes of death among adult donors.
p_agegroup_by_cod <- donor_tx_clean %>%
  filter(DON_CAD_DON_COD %in% top_causes) %>%
  mutate(cause_of_death_code = as.factor(DON_CAD_DON_COD)) %>%
  count(cause_of_death_code, age_group) %>%
  group_by(cause_of_death_code) %>%
  mutate(pct_within_cause = n / sum(n)) %>%
  ungroup() %>%
  ggplot(aes(
    x   = fct_reorder(cause_of_death_code, -pct_within_cause),
    y   = pct_within_cause,
    fill = age_group
  )) +
  geom_col() +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    title = "Age Group Composition Within Leading Causes of Death (Adults ≥18, TX ≥2020).",
    x     = "Cause of Death Code",
    y     = "Percent of Donors",
    fill  = "Age Group"
  ) +
  theme_minimal(base_size = 13)

# Print the age group composition plot.
print(p_agegroup_by_cod)
```




